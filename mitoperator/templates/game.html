<html>
  <head>
    <script src="/static/js/processing.js"></script>
    <script src="/static/js/jquery.js"></script>
    <script src="/static/js/socket.io.js"></script>
    <script type="text/javascript">
      var canvas;
      var ctx;
      var drawing=false;

      var pmouseX=null;
      var pmouseY=null;

      var currpath=null;
      var background=null;

      function Path(ctx){
        this.ctx = ctx;
        this.pts = [];
        this.draw = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[0][0], this.pts[0][1] );
          for(var i=1; i<this.pts.length; i++) {
            this.ctx.lineTo( this.pts[i][0], this.pts[i][1] );
          }
          this.ctx.stroke();
        }
        this.drawLast = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[this.pts.length-2][0], this.pts[this.pts.length-2][1] );
          this.ctx.lineTo( this.pts[this.pts.length-1][0], this.pts[this.pts.length-1][1] );
          this.ctx.stroke();
        }

      }

      $(document).ready( function() {

        function handle(delta) {
          console.log( delta );
        }

        function wheel(event){
          var delta = 0;
          if (!event) /* For IE. */
            event = window.event;
          if (event.wheelDelta) { /* IE/Opera. */
            r
            delta = event.wheelDelta/120;
          } else if (event.detail) { /** Mozilla case. */
          /** In Mozilla, sign of delta is different than in IE.
            * Also, delta is multiple of 3.
            */
            delta = -event.detail/3;
          }
          /** If delta is nonzero, handle it.
            * Basically, delta is now positive if wheel was scrolled up,
            * and negative, if wheel was scrolled down.
            */
          if (delta)
            handle(delta);
          /** Prevent default actions caused by mouse wheel.
            * That might be ugly, but we handle scrolls somehow
            * anyway, so don't bother here..
            */
          if (event.preventDefault)
            event.preventDefault();
          event.returnValue = false;
        }

        canvas = $("#canvas")[0]
        ctx = canvas.getContext("2d");

        canvas.onmousedown = function(ev) {
          if(ev.button==0) {
            ctx.lineWidth=5;

            currpath = new Path(ctx);
            background = ctx.getImageData(0,0,canvas.width,canvas.height);
          }
        }
        canvas.onmouseup = function(ev) {
          if(currpath){
            //ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.putImageData(background,0,0);

            ctx.lineWidth=1;
            currpath.draw();
            currpath = null;
          }
        }

        canvas.onmousemove = function(ev){
          if(currpath) {
            currpath.pts.push( [ev.offsetX, ev.offsetY] );
            currpath.drawLast();
          }
          pmouseX=ev.offsetX;
          pmouseY=ev.offsetY;
        } 

        if (window.addEventListener)
          /** DOMMouseScroll is for mozilla. */
          window.addEventListener('DOMMouseScroll', wheel, false);
        /** IE/Opera. */
        window.onmousewheel = document.onmousewheel = wheel;
      });
    </script>
  </head>
  <body>
    <canvas id="canvas" width="1000" height="1000"></canvas>
    <img id="dump">
  </body>
</html>
