<html>
  <head>
    <script src="/static/js/processing.js"></script>
    <script src="/static/js/jquery.js"></script>
    <script src="/static/js/socket.io.js"></script>
    <script type="text/javascript">
      var canvas;
      var ctx;
      var paths = [];

      var pmouseX=null;
      var pmouseY=null;

      var currpath=null;
      var background=null;

      var ll=0;
      var rr=1000;
      var tt=0;
      var bb=1000;

      var landcover;

      function Path(ctx){
        this.ctx = ctx;
        this.pts = [];
        this.draw = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[0][0], this.pts[0][1] );
          for(var i=1; i<this.pts.length; i++) {
            this.ctx.lineTo( this.pts[i][0], this.pts[i][1] );
          }
          this.ctx.stroke();
        }
        this.drawLast = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[this.pts.length-2][0], this.pts[this.pts.length-2][1] );
          this.ctx.lineTo( this.pts[this.pts.length-1][0], this.pts[this.pts.length-1][1] );
          this.ctx.stroke();
        }

      }

      function Landcover(ctx,imgsrc,xres,yres){
        this.ctx = ctx;
        this.xres = xres;
        this.yres = yres;

        this.img = new Image();
        var superthis=this;
        this.img.onload=function(ev){
          var cvs = document.createElement('canvas');
          var ctx = cvs.getContext('2d');
          ctx.drawImage(this,0,0,this.width,this.height);
          superthis.imgdata = ctx.getImageData(0,0,this.width,this.height);
        };
        this.img.src=imgsrc;

        this.draw = function() {
            this.ctx.drawImage(this.img,0,0,this.img.width*this.xres,this.img.height*this.yres);
        }

        this.pick = function(x,y){
          var imgx = Math.floor(x/this.xres);
          var imgy = Math.floor(y/this.yres);

          var index = imgy*this.img.width+imgx;
          return [ this.imgdata.data[index*4],this.imgdata.data[index*4+1],this.imgdata.data[index*4+2], this.imgdata.data[index*4+3] ]
        }
      }

      $(document).ready( function() {

        function apply_transform(){
          ctx.setTransform(1,0,0,1,0,0);

          var xscale = canvas.width/(rr-ll);
          var yscale = canvas.height/(bb-tt);

          ctx.translate( -ll*xscale, -tt*yscale );
          ctx.scale(xscale,yscale);
        }

        function handle(delta, x, y) {

          var scalefactor = Math.pow(1.1,delta);

          var newwidth = (rr-ll)*scalefactor;
          var newheight = (bb-tt)*scalefactor;

          var smidgex = x/canvas.width;
          var smidgey = y/canvas.height;

          var centerx = (rr-ll)*smidgex + ll;
          var centery = (bb-tt)*smidgey + tt;

          ll = centerx - newwidth*(smidgex);
          rr = centerx + newwidth*(1-smidgex);
          tt = centery - newheight*(smidgey);
          bb = centery + newheight*(1-smidgey);

          apply_transform();

          redraw();
        }

        function wheel(event){
          
          if( event.target!=canvas )
            return true;

          var delta = 0;
          if (!event)  // For IE. 
            event = window.event;
          if (event.wheelDelta) { // IE/Opera. 
            delta = event.wheelDelta/120;
          } else if (event.detail) { // Mozilla case. 
          // In Mozilla, sign of delta is different than in IE.
          // Also, delta is multiple of 3.
            delta = -event.detail/3;
          }
          // If delta is nonzero, handle it.
          // Basically, delta is now positive if wheel was scrolled up,
          // and negative, if wheel was scrolled down.
          
          if (delta)
            handle(delta, mouseX(event), mouseY(event));
          // Prevent default actions caused by mouse wheel.
          // That might be ugly, but we handle scrolls somehow
          // anyway, so don't bother here..
         
          if (event.preventDefault)
            event.preventDefault();
          event.returnValue = false;
        }

        canvas = $("#canvas")[0]
        ctx = canvas.getContext("2d");
        
        landcover = new Landcover( ctx, "/static/img/boston.png", 30, 30 );

        apply_transform()
        redraw();

        canvas.onmousedown = function(ev) {
          if(ev.button==0) {
            ctx.lineWidth=5;

            currpath = new Path(ctx);
            background = ctx.getImageData(0,0,canvas.width,canvas.height);
          }
        }

        function draw_new_path(){
            ctx.putImageData(background,0,0);
            ctx.lineWidth=1;
            currpath.draw();

            paths.push( currpath );
            currpath = null;
        }
        
        canvas.onmouseup = function(ev) {
          if(currpath){
            draw_new_path();
          } else if( ev.button==2 ) {
          }
        }
        
        canvas.oncontextmenu = function(ev) {
          return false;
        }

        function mouseX(ev) {
          return ev.clientX - ev.target.offsetLeft;
        }
        function mouseY(ev) {
          return ev.clientY - ev.target.offsetTop;
        }

        function screenX(x) {
          return (x/canvas.width)*(rr-ll)+ll;
        }

        function screenY(y) {
          return (y/canvas.height)*(bb-tt)+tt;
        }
        
        function redraw() {
            ctx.clearRect( ll,tt,(rr-ll),(bb-tt) );

            landcover.draw();

            for(var i=0; i<paths.length; i++){
              paths[i].draw();
            }

        }

        canvas.onmousemove = function(ev){
          if(currpath) {
            currpath.pts.push( [screenX(mouseX(ev)), screenY(mouseY(ev))] );
            currpath.drawLast();
          } else if( ev.button==2 ) {
            var deltax = screenX(mouseX(ev))-screenX(pmouseX);
            var deltay = screenY(mouseY(ev))-screenY(pmouseY);
            ll -= deltax;
            rr -= deltax;
            bb -= deltay;
            tt -= deltay;

            apply_transform();
            redraw();
          }

          //paint background
          var color = landcover.pick(screenX(mouseX(ev)),screenY(mouseY(ev)));
          $("body").css("background-color", "rgba("+color[0]+","+color[1]+","+color[2]+",1)");

          pmouseX=mouseX(ev);
          pmouseY=mouseY(ev);
        }

        canvas.onmouseout = function(ev) {
          if(currpath) {
            draw_new_path();
          }
        }

        if (window.addEventListener)
          // DOMMouseScroll is for mozilla.
          window.addEventListener('DOMMouseScroll', wheel, false);
        // IE/Opera.
        window.onmousewheel = document.onmousewheel = wheel;
      });
    </script>
  </head>
  <body style="background-color:#ffeeee">
    <canvas style="background-color:#ffffff;image-rendering:optimizeSpeed" id="canvas" width="1000" height="1000"></canvas>
  </body>
</html>
