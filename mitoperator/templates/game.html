<html>
  <head>
    <!--<script src="/static/js/processing.js"></script>-->
    <script src="/static/js/jquery.js"></script>
    <!--<script src="/static/js/socket.io.js"></script>-->
    <script type="text/javascript">
      var canvas;
      var ctx;
      var paths = [];

      var pmouseX=null;
      var pmouseY=null;

      var currpath=null;

      var ll=0;
      var rr=1000;
      var tt=0;
      var bb=1000;

      var landcover;
      var crop;
      var person;

      function Person(x,y) {
        this.selected = false;

        this.draw = function(ctx) {
          ctx.beginPath();
          ctx.arc(x,y,0.25,0,2*Math.PI,false);
          ctx.stroke();
        }

        this.attemptSelect = function(x,y){
          console.log( this.x, this.y, x, y );
        }
      }

      function Path(ctx){
        this.ctx = ctx;
        this.pts = [];
        this.draw = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[0][0], this.pts[0][1] );
          for(var i=1; i<this.pts.length; i++) {
            this.ctx.lineTo( this.pts[i][0], this.pts[i][1] );
          }
          this.ctx.stroke();
        }
        this.drawLast = function() {
          if( this.pts.length < 2 )
            return;

          this.ctx.beginPath();
          this.ctx.moveTo( this.pts[this.pts.length-2][0], this.pts[this.pts.length-2][1] );
          this.ctx.lineTo( this.pts[this.pts.length-1][0], this.pts[this.pts.length-1][1] );
          this.ctx.stroke();
        }

      }

      function Landcover(ctx,imgsrc,xres,yres,onload){
        this.types = {WATER:1,
        WETLAND:2,
        WETLAND_WOODY:3,
        OPEN:4,
        LOW:5,
        MEDIUM:6,
        HIGH:7,
        GRASS:8,
        TREE_MIXED:9,
        TREE_EVERGREEN:10}

        this.colors = {}
        this.colors[[73,109,163]]=this.types.WATER;
        this.colors[[112,163,191]]=this.types.WETLAND;
        this.colors[[186,216,237]]=this.types.WETLAND_WOODY;
        this.colors[[224,204,204]]=this.types.OPEN;
        this.colors[[219,153,130]]=this.types.LOW;
        this.colors[[242,0,0]]=this.types.MEDIUM;
        this.colors[[170,0,0]]=this.types.HIGH;
        this.colors[[186,204,145]]=this.types.GRASS;
        this.colors[[107,170,102]]=this.types.TREE_MIXED;
        this.colors[[28,102,51]]=this.types.TREE_EVERGREEN;

        this.ctx = ctx;
        this.xres = xres;
        this.yres = yres;

        this.img = new Image();
        var superthis=this;
        this.img.onload=function(ev){
          var cvs = document.createElement('canvas');
          var ctx = cvs.getContext('2d');
          ctx.drawImage(this,0,0,this.width,this.height);
          superthis.imgdata = ctx.getImageData(0,0,this.width,this.height);

          if(onload){
            onload()
          }
        };
        this.img.src=imgsrc;

        this.draw = function() {
            this.ctx.drawImage(this.img,0,0,this.img.width*this.xres,this.img.height*this.yres);
        }

        this.pixel = function(i){
          return [this.imgdata.data[i*4], this.imgdata.data[i*4+1], this.imgdata.data[i*4+2]];
        }

        this.pick = function(x,y){
          var imgx = Math.floor(x/this.xres);
          var imgy = Math.floor(y/this.yres);

          var index = imgy*this.img.width+imgx;
          return [ this.imgdata.data[index*4],this.imgdata.data[index*4+1],this.imgdata.data[index*4+2], this.imgdata.data[index*4+3] ]
        }

        this.classify = function(x,y){
          var color = this.pick(x,y);
          return this.colors[[color[0],color[1],color[2]]];
        }

      }

      function Crop(landcover) {
        this.product = {};
        this.product[landcover.types.WATER]=0;
        this.product[landcover.types.WETLAND]=50;
        this.product[landcover.types.WETLAND_WOODY]=50;
        this.product[landcover.types.OPEN]=20;
        this.product[landcover.types.LOW]=12;
        this.product[landcover.types.MEDIUM]=8;
        this.product[landcover.types.HIGH]=5;
        this.product[landcover.types.GRASS]=25;
        this.product[landcover.types.TREE_MIXED]=30;
        this.product[landcover.types.TREE_EVERGREEN]=35;

        this.landcover = landcover;
        this.rates = []

        for(var i=0; i<(landcover.img.width*landcover.img.height); i++) {
          var color = landcover.pixel(i);
          var type = landcover.colors[color];
          this.rates[i] = this.product[type];
        }

        this.yield = []
        for(var i=0; i<this.rates.length; i++) {
          this.yield[i]=0;
        }

        this.update = function(period) {
          for(var i=0; i<this.yield.length; i++) {
            if( this.yield[i] < 1 ) {
              var baserate = this.rates[i]*period;
              this.yield[i] += baserate/2 + (baserate/2)*Math.random();
            }
          }
        }

        this.draw = function(ctx) {
          //create temp canvas
          var tmpcvs = document.createElement('canvas');
          tmpcvs.width = this.landcover.img.width;
          tmpcvs.height = this.landcover.img.height;
          var tmpctx = tmpcvs.getContext("2d");
          var id = tmpctx.getImageData(0,0,tmpcvs.width,tmpcvs.height);
          for(var i=0; i<id.width*id.height; i++) {
            if( this.yield[i] > 1 ) {
              id.data[i*4]=230;
              id.data[i*4+1]=247;
              id.data[i*4+2]=35;
              id.data[i*4+3]=255;
            }
          }
          tmpctx.putImageData(id,0,0);

          //draw it
          ctx.drawImage( tmpcvs, 0, 0, id.width*this.landcover.xres, id.height*this.landcover.yres );
        }

      }

      $(document).ready( function() {

        function apply_transform(){
          ctx.setTransform(1,0,0,1,0,0);

          var xscale = canvas.width/(rr-ll);
          var yscale = canvas.height/(bb-tt);

          ctx.translate( -ll*xscale, -tt*yscale );
          ctx.scale(xscale,yscale);
        }

        function handle(delta, x, y) {

          var scalefactor = Math.pow(1.1,-delta);

          var newwidth = (rr-ll)*scalefactor;
          var newheight = (bb-tt)*scalefactor;

          var smidgex = x/canvas.width;
          var smidgey = y/canvas.height;

          var centerx = (rr-ll)*smidgex + ll;
          var centery = (bb-tt)*smidgey + tt;

          ll = centerx - newwidth*(smidgex);
          rr = centerx + newwidth*(1-smidgex);
          tt = centery - newheight*(smidgey);
          bb = centery + newheight*(1-smidgey);

          apply_transform();

          redraw();
        }

        function wheel(event){
          
          if( event.target!=canvas )
            return true;

          var delta = 0;
          if (!event)  // For IE. 
            event = window.event;
          if (event.wheelDelta) { // IE/Opera. 
            delta = event.wheelDelta/120;
          } else if (event.detail) { // Mozilla case. 
          // In Mozilla, sign of delta is different than in IE.
          // Also, delta is multiple of 3.
            delta = -event.detail/3;
          }
          // If delta is nonzero, handle it.
          // Basically, delta is now positive if wheel was scrolled up,
          // and negative, if wheel was scrolled down.
          
          if (delta)
            handle(delta, mouseX(event), mouseY(event));
          // Prevent default actions caused by mouse wheel.
          // That might be ugly, but we handle scrolls somehow
          // anyway, so don't bother here..
         
          if (event.preventDefault)
            event.preventDefault();
          event.returnValue = false;
        }

        canvas = $("#canvas")[0]
        ctx = canvas.getContext("2d");

        person = new Person(10,10);
        
        landcover = new Landcover( ctx, "/static/img/boston.png", 30, 30, function(){
          crop = new Crop(landcover);

          var loop;
          loop = function() {
            crop.update( 0.0004 );
            redraw();
            setTimeout( loop, 100 );
          }
          loop();

          apply_transform()
          redraw();
        });


        canvas.onmousedown = function(ev) {
          //paint background
          var color = landcover.pick(mapX(mouseX(ev)),mapY(mouseY(ev)));
          var colorstr = "rgba("+color[0]+","+color[1]+","+color[2]+",1)";
          $("body").css("background-color", colorstr);
          $("#readout").html( landcover.classify(mapX(mouseX(ev)),mapY(mouseY(ev))));

          if(ev.button==0) {
            currpath = new Path(ctx);
          }
        }

        function draw_new_path(){
            currpath.draw();

            paths.push( currpath );
            currpath = null;
        }
        
        canvas.onmouseup = function(ev) {
          if(currpath){
            draw_new_path();
          } else if( ev.button==2 ) {
          }
        }
        
        canvas.oncontextmenu = function(ev) {
          return false;
        }

        canvas.onclick = function(ev) {
          
        }

        function mouseX(ev) {
          var posx = 0;
          if (ev.pageX) {
            posx = ev.pageX;
          }
          else if (ev.clientX) {
            posx = ev.clientX + document.body.scrollLeft
                   + document.documentElement.scrollLeft;
          }

          return posx - ev.target.offsetLeft;
        }
        function mouseY(ev) {
          var posy = 0;
          if (ev.pageY) {
            posy = ev.pageY;
          }
          else if (ev.clientY) {
            posy = ev.clientY + document.body.scrollTop
                   + document.documentElement.scrollTop;
          }

          return posy - ev.target.offsetTop;
        }

        function mapX(x) {
          return (x/canvas.width)*(rr-ll)+ll;
        }

        function mapY(y) {
          return (y/canvas.height)*(bb-tt)+tt;
        }
        
        function redraw() {
            ctx.clearRect( ll,tt,(rr-ll),(bb-tt) );

            landcover.draw();

            crop.draw(ctx);

            if(currpath){
              ctx.lineWidth = 5;
              currpath.draw();
              ctx.lineWidth = 1;
            }

            for(var i=0; i<paths.length; i++){
              paths[i].draw();
            }

            person.draw(ctx);

        }

        canvas.onmousemove = function(ev){
          if(currpath) {
            currpath.pts.push( [mapX(mouseX(ev)), mapY(mouseY(ev))] );

            ctx.lineWidth=5;
            currpath.drawLast();
            ctx.lineWidth=1;
          } else if( ev.button==2 ) {
            var deltax = mapX(mouseX(ev))-mapX(pmouseX);
            var deltay = mapY(mouseY(ev))-mapY(pmouseY);
            ll -= deltax;
            rr -= deltax;
            bb -= deltay;
            tt -= deltay;

            apply_transform();
            redraw();
          }


          pmouseX=mouseX(ev);
          pmouseY=mouseY(ev);
        }

        canvas.onmouseout = function(ev) {
          if(currpath) {
            draw_new_path();
          }
        }

        if (window.addEventListener)
          // DOMMouseScroll is for mozilla.
          window.addEventListener('DOMMouseScroll', wheel, false);
        // IE/Opera.
        window.onmousewheel = document.onmousewheel = wheel;

      });
    </script>
  </head>
  <body style="background-color:#ffeeee">
    <canvas style="background-color:#ffffff;image-rendering:optimizeSpeed" id="canvas" width="1000" height="1000"></canvas>
    <div id="readout"></div>
  </body>
</html>
